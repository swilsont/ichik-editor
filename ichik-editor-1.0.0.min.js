/**
 * IchikEditor.js (c) 2025 Sebastian Wilson T. https://github.com/swilsont/ichik-editor
 * Licensed under the MIT License.
 */
const IchikEditor=function(){const e=["ğŸ˜€","ğŸ˜","ğŸ˜‚","ğŸ¤£","ğŸ˜‰","ğŸ˜Š","ğŸ¥°","ğŸ˜","ğŸ¤”","ğŸ¤¨","ğŸ˜","ğŸ˜‘","ğŸ˜¶","ğŸ™„","ğŸ˜","ğŸ˜£","ğŸ˜¥","ğŸ˜®","ğŸ˜´","ğŸ˜«","ğŸ˜œ","ğŸ˜","ğŸ˜­","ğŸ˜±","ğŸ˜¡","ğŸ‘","ğŸ‘","ğŸ‘‹","ğŸ™Œ","ğŸ‘","ğŸ¤","ğŸ’ª","ğŸ‰","âœ¨","ğŸ”¥","â¤ï¸","ğŸš€","â­","ğŸ’¡","âœ…"],t={toolbar:{formats:{normal:"Normal",h1:"Heading 1",h2:"Heading 2",h3:"Heading 3",h4:"Heading 4",h5:"Heading 5",h6:"Heading 6"},bold:"<strong>B</strong>",italic:"<em>I</em>",ul:"â€¢ Bullet List",ol:"1. Numbered List",hr:"â€”",link:"ğŸ”— Link",image:"ğŸ–¼ï¸ Image",emoji:"ğŸ˜€ Emoji",clear:"Clear format"},popups:{link:{title:"Link URL",placeholder:"https://...",cancel:"Cancel",save:"Save"},image:{titleUrl:"Image URL",placeholderUrl:"https://...",titleAlt:"Description (Alt Text, optional)",placeholderAlt:"Ex: Company Name's Logo",titleWidth:"Width (Optional)",placeholderWidth:"Ex: 300px or 100%",cancel:"Cancel",insert:"Insert",update:"Update"}},alerts:{httpsRequired:"For security reasons, only HTTPS URLs are allowed.",invalidProtocol:"Protocol not allowed. Only HTTPS."}},n=[{type:"select",cmd:"formatBlock",options:[{labelKey:"normal",value:"P"},{labelKey:"h1",value:"H1"},{labelKey:"h2",value:"H2"},{labelKey:"h3",value:"H3"},{labelKey:"h4",value:"H4"},{labelKey:"h5",value:"H5"},{labelKey:"h6",value:"H6"}]},{type:"button",labelKey:"bold",cmd:"bold"},{type:"button",labelKey:"italic",cmd:"italic"},{type:"separator"},{type:"button",labelKey:"ul",cmd:"insertUnorderedList"},{type:"button",labelKey:"ol",cmd:"insertOrderedList"},{type:"button",labelKey:"hr",cmd:"insertHorizontalRule"},{type:"separator"},{type:"button",labelKey:"emoji",cmd:"toggleEmoji"},{type:"button",labelKey:"link",cmd:"createLink"},{type:"button",labelKey:"image",cmd:"customInsertImage"},{type:"separator"},{type:"button",labelKey:"clear",cmd:"removeFormat"}];function l(e,t){if(!e)return null;let n=e.trim();return n.toLowerCase().startsWith("https://")?n:n.toLowerCase().startsWith("http://")?(alert(t.httpsRequired),null):/^[a-zA-Z0-9\-\.]+:\/\//.test(n)?(alert(t.invalidProtocol),null):"https://"+n}function o(e,t,n){t.style.display=n;const l=e.getBoundingClientRect(),o=t.offsetWidth,i=window.innerWidth,a=window.scrollX,c=window.scrollY;let r=l.left+a,s=l.bottom+c+6;l.left+o>i-10&&(r=l.right+a-o),r<10&&(r=10),t.style.left=r+"px",t.style.top=s+"px"}function i(t){t.container.innerHTML="",t.container.classList.add("ichik-editor-container");const l=document.createElement("div");l.className="ichik-toolbar",function(e,t){n.forEach(n=>{if("select"===n.type){const l=document.createElement("select");l.dataset.cmd=n.cmd,n.options.forEach(t=>{const n=document.createElement("option");n.value=t.value,n.textContent=e.labels.toolbar.formats[t.labelKey],l.appendChild(n)}),l.onchange=(t=>{t.preventDefault(),document.execCommand(n.cmd,!1,l.value),e.editorEl.focus()}),e.uiRefs.selects.push(l),t.appendChild(l)}else if("button"===n.type){const l=document.createElement("button");l.innerHTML=e.labels.toolbar[n.labelKey],l.dataset.cmd=n.cmd,l.onclick=(t=>(function(e,t,n,l){t.preventDefault(),["createLink","customInsertImage","toggleEmoji"].includes(n.cmd)&&t.stopPropagation();if("createLink"===n.cmd)if("flex"===e.popupEl.style.display)c(e);else{const t=function(e){const t=window.getSelection();if(t.rangeCount>0){let n=t.anchorNode;for(;n&&n!==e.editorEl;){if("A"===n.tagName)return n;n=n.parentNode}}return null}(e);a(e,"link",l,t)}else if("customInsertImage"===n.cmd)if("flex"===e.popupEl.style.display)c(e);else{const t=function(e){const t=window.getSelection();if(0===t.rangeCount)return null;const n=t.getRangeAt(0);if(t.anchorNode&&"IMG"===t.anchorNode.tagName)return t.anchorNode;if(n.startContainer===n.endContainer&&n.endOffset-n.startOffset==1){const e=n.startContainer.childNodes[n.startOffset];if(e&&"IMG"===e.tagName)return e}return null}();a(e,"image",l,t)}else"toggleEmoji"===n.cmd?"grid"===e.emojiPickerEl.style.display?c(e):(c(e),s(e),o(l,e.emojiPickerEl,"grid")):"removeFormat"===n.cmd?(e.editorEl.focus(),document.execCommand("removeFormat",!1,null),document.execCommand("formatBlock",!1,"P"),document.execCommand("unlink",!1,null),r(e)):(e.editorEl.focus(),document.execCommand(n.cmd,!1,null),r(e))})(e,t,n,l)),e.uiRefs.buttons.push(l),t.appendChild(l)}else if("separator"===n.type){const e=document.createElement("span");e.style.cssText="width: 1px; height: 20px; background: #ccc; margin: 0 4px;",t.appendChild(e)}})}(t,l),t.container.appendChild(l),t.editorEl=document.createElement("div"),t.editorEl.className="ichik-editor",t.editorEl.contentEditable=!0,t.editorEl.innerHTML="",t.container.appendChild(t.editorEl),function(e){e.tooltipEl=document.createElement("div"),e.tooltipEl.className="ichik-tooltip",document.body.appendChild(e.tooltipEl)}(t),function(t){t.emojiPickerEl=document.createElement("div"),t.emojiPickerEl.className="ichik-emoji-picker",t.emojiPickerEl.style.display="none",t.emojiPickerEl.addEventListener("click",e=>e.stopPropagation()),e.forEach(e=>{const n=document.createElement("span");n.textContent=e,n.className="ichik-emoji-item",n.onclick=(()=>{d(t),document.execCommand("insertText",!1,e),c(t)}),t.emojiPickerEl.appendChild(n)}),document.body.appendChild(t.emojiPickerEl)}(t),function(e){e.popupEl=document.createElement("div"),e.popupEl.className="ichik-popup",e.popupEl.style.display="none",e.popupEl.addEventListener("click",e=>e.stopPropagation()),document.body.appendChild(e.popupEl)}(t),function(e){e.editorEl.addEventListener("paste",e=>{e.preventDefault();const t=(e.clipboardData||window.clipboardData).getData("text/plain");document.execCommand("insertText",!1,t)}),e.editorEl.addEventListener("click",t=>{if("IMG"===t.target.tagName){const n=document.createRange();n.selectNode(t.target);const l=window.getSelection();l.removeAllRanges(),l.addRange(n),r(e)}}),e.editorEl.addEventListener("keyup",()=>r(e)),e.editorEl.addEventListener("mouseup",()=>r(e)),document.addEventListener("click",()=>{"none"===e.emojiPickerEl.style.display&&"none"===e.popupEl.style.display||c(e)}),e.editorEl.addEventListener("mousemove",t=>{let n=t.target;3===n.nodeType&&(n=n.parentNode);const l=n.closest?n.closest("a"):null;l&&e.editorEl.contains(l)?(e.tooltipEl.textContent=`ğŸ”— ${l.getAttribute("href")}`,e.tooltipEl.style.display="block",e.tooltipEl.style.left=t.clientX+15+"px",e.tooltipEl.style.top=t.clientY+15+"px"):e.tooltipEl.style.display="none"}),e.editorEl.addEventListener("mouseleave",()=>e.tooltipEl.style.display="none")}(t)}function a(e,t,n,i=null){c(e),s(e);let a="";const r=e.labels.popups;if("link"===t){const e=i?i.href:"";i&&function(e){const t=document.createRange();t.selectNode(e);const n=window.getSelection();n.removeAllRanges(),n.addRange(t)}(i),a=`<label>${r.link.title}</label><input type="text" id="ichik-inp-url" value="${e}" placeholder="${r.link.placeholder}"><div class="ichik-popup-actions"><button id="ichik-btn-cancel" class="ichik-btn-cancel">${r.link.cancel}</button><button id="ichik-btn-save" class="ichik-btn-save">${r.link.save}</button></div>`}else if("image"===t){const e=i?i.getAttribute("src"):"",t=i?i.getAttribute("alt"):"",n=i&&i.getAttribute("width")||"",l=i?r.image.update:r.image.insert;a=`<label>${r.image.titleUrl}</label><input type="text" id="ichik-inp-url" value="${e}" placeholder="${r.image.placeholderUrl}"><label>${r.image.titleAlt}</label><input type="text" id="ichik-inp-alt" value="${t}" placeholder="${r.image.placeholderAlt}"><label>${r.image.titleWidth}</label><input type="text" id="ichik-inp-width" value="${n}" placeholder="${r.image.placeholderWidth}"><div class="ichik-popup-actions"><button id="ichik-btn-cancel" class="ichik-btn-cancel">${r.image.cancel}</button><button id="ichik-btn-save" class="ichik-btn-save">${l}</button></div>`}e.popupEl.innerHTML=a,o(n,e.popupEl,"flex"),setTimeout(()=>{const t=e.popupEl.querySelector("input");t&&t.focus()},50),e.popupEl.querySelector("#ichik-btn-cancel").onclick=(()=>c(e)),e.popupEl.querySelector("#ichik-btn-save").onclick=(()=>{const n=e.popupEl.querySelector("#ichik-inp-url").value;if("link"===t)if(d(e),n.trim()){const t=l(n,e.labels.alerts);t&&document.execCommand("createLink",!1,t)}else document.execCommand("unlink",!1,null);else if("image"===t){d(e);const t=l(n,e.labels.alerts);if(t){const n=e.popupEl.querySelector("#ichik-inp-alt").value||"",l=e.popupEl.querySelector("#ichik-inp-width").value||"";if(i)i.setAttribute("src",t),i.setAttribute("alt",n),l&&/^\d+(px|%)?$/.test(l)?i.setAttribute("width",l):i.removeAttribute("width");else{const e=document.createElement("img");e.setAttribute("src",t),e.setAttribute("alt",n),l&&/^\d+(px|%)?$/.test(l)&&e.setAttribute("width",l),document.execCommand("insertHTML",!1,e.outerHTML)}}}c(e)})}function c(e){e.emojiPickerEl.style.display="none",e.popupEl.style.display="none",e.editorEl.focus()}function r(e){e.uiRefs.buttons.forEach(e=>{const t=e.dataset.cmd;try{document.queryCommandState(t)?e.classList.add("active"):e.classList.remove("active")}catch(e){}}),e.uiRefs.selects.forEach(e=>{if("formatBlock"===e.dataset.cmd){let t=document.queryCommandValue("formatBlock");"DIV"===(t=t?t.toUpperCase():"P")&&(t="P"),Array.from(e.options).some(e=>e.value===t)&&(e.value=t)}})}function s(e){const t=window.getSelection();if(t.rangeCount>0&&e.editorEl.contains(t.anchorNode))e.savedSelection=t.getRangeAt(0);else{e.editorEl.focus();const n=document.createRange();n.selectNodeContents(e.editorEl),n.collapse(!1),t.removeAllRanges(),t.addRange(n),e.savedSelection=n}}function d(e){if(e.editorEl.focus(),e.savedSelection){const t=window.getSelection();t.removeAllRanges(),t.addRange(e.savedSelection)}}return class{constructor(e,n={}){let l=document.getElementById(e);if(l||(l=document.querySelector(e)),!l)throw new Error(`IchikEditor: Element not found (${e})`);this.container=l,this.labels=JSON.parse(JSON.stringify(t)),n.labels&&function e(t,n){for(const l in n)n[l]instanceof Object&&l in t&&Object.assign(n[l],e(t[l],n[l]));return Object.assign(t||{},n),t}(this.labels,n.labels),this.editorEl=null,this.tooltipEl=null,this.emojiPickerEl=null,this.popupEl=null,this.savedSelection=null,this.uiRefs={buttons:[],selects:[]},i(this)}getMarkdown(){return function e(t){if(t.nodeType===Node.TEXT_NODE)return(n=t.textContent)?n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):"";var n;let l="";switch(t.childNodes.forEach(t=>l+=e(t)),t.tagName){case"B":case"STRONG":return`**${l}**`;case"I":case"EM":return`*${l}*`;case"H1":return`# ${l}\n\n`;case"H2":return`## ${l}\n\n`;case"H3":return`### ${l}\n\n`;case"H4":return`#### ${l}\n\n`;case"H5":return`##### ${l}\n\n`;case"H6":return`###### ${l}\n\n`;case"DIV":case"P":return l.trim()?`${l}\n\n`:"";case"BR":return"\n";case"UL":case"OL":return`${l}\n`;case"LI":const n=t.parentElement;return`${"OL"===n.tagName?Array.from(n.children).indexOf(t)+1+". ":"- "}${l}\n`;case"HR":return"\n---\n\n";case"A":return`[${l}](${t.getAttribute("href")})`;case"IMG":const o=t.getAttribute("alt")||"",i=t.getAttribute("src"),a=t.getAttribute("width");return a?`\n<img src="${i}" alt="${o}" width="${a}">\n`:`\n![${o}](${i})\n`;default:return l}}(this.editorEl).trim()}getHTML(){return this.editorEl.innerHTML.trim()}setHTML(e){this.editorEl&&(this.editorEl.innerHTML=e)}}}();